name: Validate and Auto-Merge Tests

on:
  pull_request:
    branches: [main]
    paths: ['test_classes.py']

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout student PR
      uses: actions/checkout@v4

    - name: Clone autograder (private)
      env:
        SSH_KEY: ${{ secrets.AUTOGRADER_DEPLOY_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa" git clone git@github.com:DATA120/Spring25-test-classes-instructors.git

    - name: Validate submission
      run: |
        python3 autograder/scripts/validate_tests.py "${{ github.event.pull_request.user.login }}" > result.txt 2>&1 || echo "FAILED" >> result.txt
        cat result.txt

    - name: Check result
      id: result
      run: |
        if grep -q "FAILED" result.txt; then
          echo "merge=no" >> $GITHUB_OUTPUT
        else
          echo "merge=yes" >> $GITHUB_OUTPUT
        fi

    - name: Comment on failure
      if: steps.result.outputs.merge == 'no'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const msg = fs.readFileSync('result.txt', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `‚ùå **Your submission failed validation.**\n\n\`\`\`\n${msg}\n\`\`\`\nPlease revise and resubmit.`
          });

    - name: Auto-merge passing PRs
      if: steps.result.outputs.merge == 'yes'
      uses: "peter-evans/enable-pull-request-automerge@v3"
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        merge-method: squash
